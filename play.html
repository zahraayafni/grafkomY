<html>
	<head>
		<title>Play Beat.ly</title>
		<link href="https://fonts.googleapis.com/css?family=Fredoka+One|Major+Mono+Display|Cinzel" rel="stylesheet">
		<link rel="stylesheet" type="text/css" href="style.css">
		<style>
			body { margin: 0; }
			canvas { width: 100%; height: 100% }
			@font-face
			{
				font-family: NeonLights;
				src: url('font/neon2.ttf'); 
			}
		</style>
	</head>
	<body onload="funcOnload()">
		<div class="menu" style="display: none; color: white;">
			<img id="homeButton" src="img/homeButton.png"><br>
		</div>

	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
	<script src="lib/build/three.js"></script>
	<script src="https://unpkg.com/three.texttexture@18.10.24"></script>
	<script src="lib/js/loaders/FBXLoader.js"></script>
	<script src="lib/js/libs/inflate.min.js"></script>
	<script src="lib/THREE.TextSprite.js"></script>
	<script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
	<script>
		var camera;
		var scene;
		var colors;
		var renderer;
		var loadHeart, objectH;
		// var groupLife = [];
		var loader, loader2, loader3, loader4;
		var plate1, plate2, plate3, plate4;
		var plateArr = [];
		var loaderTap;
		var taptap;


		function init()
		{

			var listener = new THREE.AudioListener();
			var audio = new THREE.Audio( listener );
			var mediaElement = new Audio( 'sugar.mp3' );
			//mediaElement.loop = true;
			// mediaElement.play();
			//Colors
			colors = ['#15959F', '#F1E4B3', '#F4A090', '#F26144'];

			//Scene
			scene = new THREE.Scene();

			//Camera
			camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 1, 1000);
			camera.position.set(0, 0, 50);
			camera.lookAt(scene.position);

			//Renderer
			renderer = new THREE.WebGLRenderer({antialias: true});

			renderer.setClearColor(0x000000);
			renderer.setSize( window.innerWidth, window.innerHeight );
			document.body.appendChild( renderer.domElement );

			//add Life
			loadHeart = new THREE.FBXLoader();
			loadHeart.load('obj/heart.fbx', function(obj) {
				objectH = obj;
				objectH.scale.x = objectH.scale.y = objectH.scale.z = 0.3;
				objectH.rotation.y = 0.075 * -Math.PI;
				objectH.rotation.z = 0.03 * -Math.PI;
				console.log(objectH); 
                var i, j, instance;
                for ( i = 800; i < 1201; i += 150 ) {
				    instance = objectH.clone();
				    instance.position.set( i, 450, -700 );
				    // groupLife.push(instance);
				    scene.add(instance);
				}
			});

			//GAME START pop-up
			var startSprite = new THREE.TextSprite({
				textSize: 10,
				material: {
					color: 0xe5e4e2,
				},
				texture: {
					text: 'START',
					fontFamily: 'Major Mono Display, monospace',
					fontWeight: 'bold',
				},
			});
			startSprite.position.set(-window.innerWidth/400, window.innerHeight/300, 0);
			scene.add(startSprite);			
			gameStart();

			//game start
			function gameStart()
			{
				setTimeout(function(){
					scene.remove(startSprite);
					mediaElement.play();
					beat();	
    			}, 5000);
			}

			//beat
			//Grouping plate per lane
			var size = 0.5, posY = 120, posZ=-900;

			loader = new THREE.FBXLoader();
			loader.load('obj/bluePlate.fbx', function(obj) {
				plate1 = obj;
			});

			loader2 = new THREE.FBXLoader();
			loader2.load('obj/redPlate.fbx', function(obj) {
				plate2 = obj;
			});

			loader3 = new THREE.FBXLoader();
			loader3.load('obj/greenPlate.fbx', function(obj) {
				plate3 = obj;
			});

			loader4 = new THREE.FBXLoader();
			loader4.load('obj/yellowPlate.fbx', function(obj) {
				plate4 = obj;
			});

			//Susunan berdasarkan lagu "addPlate(detik keberapa, lane berapa)"
			function beat() {
				addPlate(1, 1);
				addPlate(4, 2);
				addPlate(6, 2);
				addPlate(7, 3);
				addPlate(8, 4);
				addPlate(9, 4);
				addPlate(10, 1);
			}

			//LoadTaptap
			loaderTap = new THREE.FBXLoader();
			loaderTap.load('obj/taptapv1.fbx', function(obj) {
				taptap = obj;
				taptap.scale.x = taptap.scale.y = taptap.scale.z = 0.41;
				taptap.rotation.y = 0.5  * Math.PI;
				//taptap.rotation.x = 0;
				taptap.position.set(-50, -350, -460);
				//taptap.ambientLight=0;
				console.log(taptap);
                scene.add(taptap);

			});
						
			//Title of the game
            var sprite = new THREE.TextSprite({
				textSize: 8,
				material: {
					color: 0x8cb8ff,
				},
				texture: {
					text: 'Beat.ly',
					fontFamily: 'NeonLights, Helvetica, sans-serif',
				},
			});
			sprite.position.set(-window.innerWidth/20, window.innerHeight/20, 0);
			scene.add(sprite);


			//GAME OVER pop-up
			var gameoverSprite = new THREE.TextSprite({
				textSize: 10,
				material: {
					color: 0xFF0000,
				},
				texture: {
					text: 'GAME OVER',
					fontFamily: 'Cinzel, serif',
					fontWeight: 'bold',
				},
			});
			gameoverSprite.position.set(-window.innerWidth/400, window.innerHeight/300, 0);
			//scene.add(gameoverSprite);

			//SCORE pop-up
			var scoreSprite = new THREE.TextSprite({
				textSize: 10,
				material: {
					color: 0x32a232,
				},
				texture: {
					text: 'SCORE',
					fontFamily: 'Fredoka One, cursive',
					fontWeight: 'bold',
				},
			});
			scoreSprite.position.set(-window.innerWidth/400, window.innerHeight/30, 0);
			//scene.add(scoreSprite);




			// Create a shape for background
			//var bgArr = [];
			var bg = new THREE.Group();
			var geometry = new THREE.DodecahedronBufferGeometry(1,0);
			var shapeCount = 500;
			
			for (var i = 0; i < shapeCount; i++) {
			  colorIndex = Math.round(Math.random() * colors.length - 1);
			  material = new THREE.MeshLambertMaterial({ color: colors[colorIndex] });
			  var shape = new THREE.Mesh(geometry, material);
			  var px = Math.random() * 100 - 50,
			      py = Math.random() * 100 - 50,
			      pz = Math.random() * 100 - 50;
			  var rx = Math.random() * Math.PI * 2,
			      ry = Math.random() * Math.PI * 2,
			      rz = Math.random() * Math.PI * 2;
			  var scale = Math.random() * .5;
			  shape.position.set(px,py,pz);
			  shape.rotation.set(rx,ry,rz);
			  shape.scale.set(scale,scale,scale);
			  
			  //bgArr.push(shape);
			  bg.add(shape);
			}
			scene.add(bg);

			//Add Controls
			var controls = new THREE.OrbitControls(camera, renderer.domElement);
			controls.minDistance = 50;
			controls.maxDistance = 200;
			controls.enableZoom = false;
			controls.enableRotate = false;

			//LIGHTING
			var ambientLight = new THREE.AmbientLight(0x111111);
        	scene.add(ambientLight);

        	// add pointLight for the shadows
        	var pointLight = new THREE.PointLight(0xffffff,1,0,0.55 * Math.PI);
        	pointLight.position.set(0, 15, 0);
        	pointLight.castShadow = true;

        	pointLight.shadow.mapSize.width = 1024 ;
        	pointLight.shadow.mapSize.height = 1024 ;

        	scene.add(pointLight);

			animate();

			var animSpeed = .001;
			var i = 0, distX=1, distY=3, distZ=3;

			function animate()
			{
				requestAnimationFrame( animate );

				bg.position.x = Math.sin(i/180)*10;
				bg.position.y = Math.sin(i/180)*5+5;
				i += 1;

				plateArr.forEach(function(el, idx) {
					plateAnim(el, idx);
				});
				renderer.render( scene, camera );
			}

			function plateAnim(plate, idx)
			{
				plate.position.x += distX;
				plate.position.y -= distY;
				plate.position.z += distZ;

				if(plate.position.y < -window.innerHeight) {
					scene.remove(plate);
					plateArr.splice(idx,1);
				}
			}

			function addPlate(time, lane)
			{
				setTimeout(function(){
					switch(lane) {
						case 1: 
							var plates1 = plate1.clone();
							plates1.scale.x = plates1.scale.y = plates1.scale.z = size;
							plates1.rotation.x = 0.15 * Math.PI;
							plates1.position.set(-200, posY, posZ);
							plateArr.push(plates1);
							scene.add(plates1);
							break;
						case 2:
							var plates2 = plate2.clone();						
							plates2.scale.x = plates2.scale.y = plates2.scale.z = size;
							plates2.rotation.x = 0.15 * Math.PI;
							plates2.position.set(-100, posY, posZ);
							plateArr.push(plates2);
							scene.add(plates2);
							break;
						case 3:							
							var plates3 = plate3.clone();
							plates3.scale.x = plates3.scale.y = plates3.scale.z = size;
							plates3.rotation.x = 0.15 * Math.PI;
							plates3.position.set(0, posY, posZ);
							plateArr.push(plates3);
							scene.add(plates3);
							break;
						case 4:
							var plates4 = plate4.clone();
							plates4.scale.x = plates4.scale.y = plates4.scale.z = size;
							plates4.rotation.x = 0.15 * Math.PI;
							plates4.position.set(100, posY, posZ);
							plateArr.push(plates4);
							scene.add(plates4);
							break;
					}
		          					
    			}, time*1000);
			}
		}

		function onResize() {
        	camera.aspect = window.innerWidth / window.innerHeight;
        	camera.updateProjectionMatrix();
        	renderer.setSize(window.innerWidth, window.innerHeight);
    	}
   
    	//Listen to keyboard event
    	window.onkeydown = function(event) {
    		var input = event.key;
    		var range = 10;
    		switch(input) {
        		case 'a': 
            		object.position.z += range;
            		break;
        		case 's':
            		object.position.z -= range;
            		break;
        		case 'k':
            		object.position.y += range;
            		break;
        		case 'l':
            		object.position.x += range;
            		break;
    		}
		}

    	// window.onload = init;
    	
    	// listen to the resize events
    	window.addEventListener('resize', onResize, false);
		
		function funcOnload() { 
    		init();
    		$('.menu').css('display', 'block'); 
		}

		var home = document.getElementById('homeButton');
		home.onclick = function() {
			window.location.href = 'mainPage.html';
		}

		</script>
	</body>
</html>